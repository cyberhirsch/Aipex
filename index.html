<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Aipex - Generative AI Ranking</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>Aipex - Generative AI Ranking</h1>
        <!-- Authentication Buttons -->
        <div id="authSection">
            <button id="signInBtn">Sign In with Google</button>
            <button id="signOutBtn" style="display: none;">Sign Out</button>
        </div>
    </header>
    <main>
        <!-- Tag Filters Section -->
        <section id="tagFilters">
            <h2>Filter by Tags</h2>
            <div id="tagsFilterContainer">
                <!-- Tag checkboxes will be populated here -->
            </div>
        </section>

        <!-- Ranking Section -->
        <section id="ranking">
            <div id="toolsList" class="tools-grid">
                <!-- Top tools will appear here in a compact format -->
            </div>
        </section>

        <!-- Add Tool Section (Admin Only) -->
        <section id="addTool" class="admin-only" style="display: none;">
            <h2>Add a New Tool</h2>
            <form id="addToolForm">
                <div class="form-group">
                    <label for="toolName">Tool Name:</label>
                    <input type="text" id="toolName" placeholder="e.g., GPT-4, DALL-E 3" required>
                </div>
                <div class="form-group">
                    <label>Categories:</label>
                    <div id="toolCategoriesContainer">
                        <!-- Category checkboxes will be populated dynamically -->
                    </div>
                    <small>Select one or more categories.</small>
                </div>
                <div class="form-group">
                    <label for="toolLicense">License:</label>
                    <select id="toolLicense" required>
                        <option value="" disabled selected>Select a license type</option>
                        <option value="Open Source">Open Source</option>
                        <option value="Commercial">Commercial</option>
                        <option value="Freemium">Freemium</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="toolWeblink">Weblink:</label>
                    <input type="text" id="toolWeblink" placeholder="e.g., https://tool-link.com" required>
                </div>
                <div class="form-group">
                    <label>Tags:</label>
                    <div id="toolTagsContainer">
                        <!-- Tag checkboxes will be populated dynamically -->
                    </div>
                    <small>Select one or more tags.</small>
                </div>
                <button type="submit">Add Tool</button>
            </form>
        </section>

        <!-- Suggest Tool Section (Non-Admin Users) -->
        <section id="suggestTool" class="non-admin-only suggestion-section">
            <h2>Suggest a New Tool</h2>
            <p>Log in to make a suggestion.</p>
        </section>

        <!-- Add Category Section (Admin Only) -->
        <section id="addCategory" class="admin-only" style="display: none;">
            <h2>Add a New Category</h2>
            <form id="addCategoryForm">
                <div class="form-group">
                    <label for="categoryName">Category Name:</label>
                    <input type="text" id="categoryName" placeholder="e.g., NLP, Vision" required>
                </div>
                <button type="submit">Add Category</button>
            </form>
        </section>

        <!-- Suggest Category Section (Non-Admin Users) -->
        <section id="suggestCategory" class="non-admin-only suggestion-section">
            <h2>Suggest a New Category</h2>
            <p>Log in to make a suggestion.</p>
        </section>

        <!-- Add Tag Section (Admin Only) -->
        <section id="addTag" class="admin-only" style="display: none;">
            <h2>Add a New Tag</h2>
            <form id="addTagForm">
                <div class="form-group">
                    <label for="tagName">Tag Name:</label>
                    <input type="text" id="tagName" placeholder="e.g., NLP, Transformer" required>
                </div>
                <button type="submit">Add Tag</button>
            </form>
        </section>

        <!-- Suggest Tag Section (Non-Admin Users) -->
        <section id="suggestTag" class="non-admin-only suggestion-section">
            <h2>Suggest a New Tag</h2>
            <p>Log in to make a suggestion.</p>
        </section>
    </main>
    <footer>
        <p>Updated: November 2024</p>
        <p>Aipex Version: v0.1.7</p>
        <a href="admin.html" class="admin-link" style="display: none;">Admin Page</a>
    </footer>

    <!-- Firebase and Main Script -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getDatabase, ref, onValue, get, update, push } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCrSS4lsxgSFA7SEtseW1KoiruQbUwR_xA",
            authDomain: "aipex-6d63b.firebaseapp.com",
            databaseURL: "https://aipex-6d63b-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "aipex-6d63b",
            storageBucket: "aipex-6d63b.appspot.com",
            messagingSenderId: "356818143159",
            appId: "1:356818143159:web:49222b5a85629c4630ca32",
            measurementId: "G-D32Z47WHQ4"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth();
        const db = getDatabase();

        let isAdmin = false;
        let currentUser = null;
        let tools = []; // Declare tools array globally

        // Authentication Functions
        window.addEventListener('load', function () {
            // Sign-In Function
            const signInBtn = document.getElementById('signInBtn');
            const signOutBtn = document.getElementById('signOutBtn');

            signInBtn.addEventListener('click', () => {
                const provider = new GoogleAuthProvider();
                signInWithPopup(auth, provider)
                    .then((result) => {
                        console.log('User signed in:', result.user);
                    })
                    .catch((error) => {
                        console.error('Error during sign-in:', error);
                        alert('Error during sign-in. Please try again.');
                    });
            });

            // Sign-Out Function
            signOutBtn.addEventListener('click', () => {
                signOut(auth).then(() => {
                    console.log('User signed out');
                }).catch((error) => {
                    console.error('Error during sign-out:', error);
                    alert('Error during sign-out. Please try again.');
                });
            });

            // Authentication State Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    signInBtn.style.display = 'none';
                    signOutBtn.style.display = 'block';
                    checkIfAdmin(user.uid);
                } else {
                    currentUser = null;
                    isAdmin = false;
                    signInBtn.style.display = 'block';
                    signOutBtn.style.display = 'none';
                    updateUIForRole();
                }
            });

            // Check if user is admin
            function checkIfAdmin(uid) {
                const adminRef = ref(db, `admins/${uid}`);
                onValue(adminRef, (snapshot) => {
                    isAdmin = snapshot.exists();
                    updateUIForRole();
                });
            }

            // Update UI based on user role
            function updateUIForRole() {
                // Show or hide admin-only sections
                const adminSections = document.querySelectorAll('.admin-only');
                adminSections.forEach(section => {
                    section.style.display = isAdmin ? 'block' : 'none';
                });

                // Show or hide non-admin-only sections
                const nonAdminSections = document.querySelectorAll('.non-admin-only');
                nonAdminSections.forEach(section => {
                    section.style.display = isAdmin ? 'none' : 'block';
                });

                // Update Editor's Choice checkboxes and icons
                const editorChoiceCheckboxes = document.querySelectorAll('.editor-choice-checkbox');
                editorChoiceCheckboxes.forEach(checkbox => {
                    const icon = checkbox.parentElement.querySelector('.editor-choice-icon');
                    if (isAdmin) {
                        checkbox.style.display = 'inline-block';
                        if (icon) icon.style.display = 'none';
                    } else {
                        checkbox.style.display = 'none';
                        if (checkbox.checked && icon) {
                            icon.style.display = 'inline-block';
                        } else if (icon) {
                            icon.style.display = 'none';
                        }
                    }
                });

                // Update Suggestion Sections
                const suggestionSections = document.querySelectorAll('.suggestion-section');
                suggestionSections.forEach(section => {
                    if (currentUser) {
                        const form = section.querySelector('form');
                        if (form) {
                            form.style.display = 'block';
                        } else {
                            // Re-insert the form if it's missing
                            // You may need to store the form HTML elsewhere
                        }
                        section.querySelector('p').style.display = 'none';
                    } else {
                        const form = section.querySelector('form');
                        if (form) form.style.display = 'none';
                        const message = section.querySelector('p');
                        if (message) message.style.display = 'block';
                    }
                });

                // Update Admin Page link visibility
                const adminLinks = document.querySelectorAll('.admin-link');
                adminLinks.forEach(link => {
                    link.style.display = isAdmin ? 'inline' : 'none';
                });
            }

            // Fetch categories from database
            const toolCategoriesContainer = document.getElementById('toolCategoriesContainer');
            const suggestToolCategoriesContainer = document.getElementById('suggestToolCategoriesContainer');

            function populateCategories() {
                onValue(ref(db, 'categories/'), (snapshot) => {
                    toolCategoriesContainer.innerHTML = ''; // Clear existing categories
                    suggestToolCategoriesContainer.innerHTML = ''; // Clear existing categories
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const category = childSnapshot.val();
                            const categoryElement = document.createElement('div');
                            categoryElement.className = 'category-checkbox';
                            categoryElement.innerHTML = `
                                <input type="checkbox" id="toolCategory-${category}" value="${category}" class="tool-category-checkbox">
                                <label for="toolCategory-${category}">${category}</label>
                            `;
                            toolCategoriesContainer.appendChild(categoryElement);

                            const suggestCategoryElement = categoryElement.cloneNode(true);
                            suggestToolCategoriesContainer.appendChild(suggestCategoryElement);
                        });
                    }
                });
            }
            populateCategories();

            // Fetch tags from database
            const tagsFilterContainer = document.getElementById('tagsFilterContainer');
            const toolTagsContainer = document.getElementById('toolTagsContainer');
            const suggestToolTagsContainer = document.getElementById('suggestToolTagsContainer');

            function populateTags() {
                onValue(ref(db, 'tags/'), (snapshot) => {
                    tagsFilterContainer.innerHTML = '';
                    toolTagsContainer.innerHTML = '';
                    suggestToolTagsContainer.innerHTML = '';
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const tag = childSnapshot.val();

                            // Populate tagsFilterContainer
                            const tagElement = document.createElement('div');
                            tagElement.className = 'tag-filter';
                            tagElement.innerHTML = `
                                <input type="checkbox" id="tagFilter-${tag}" value="${tag}" class="tag-checkbox">
                                <label for="tagFilter-${tag}">${tag}</label>
                            `;
                            tagsFilterContainer.appendChild(tagElement);

                            // Populate toolTagsContainer (Admin Form)
                            const tagCheckbox = document.createElement('div');
                            tagCheckbox.className = 'tag-checkbox';
                            tagCheckbox.innerHTML = `
                                <input type="checkbox" id="toolTag-${tag}" value="${tag}" class="tool-tag-checkbox">
                                <label for="toolTag-${tag}">${tag}</label>
                            `;
                            toolTagsContainer.appendChild(tagCheckbox);

                            // Populate suggestToolTagsContainer (Suggestion Form)
                            const suggestTagCheckbox = tagCheckbox.cloneNode(true);
                            suggestToolTagsContainer.appendChild(suggestTagCheckbox);
                        });

                        // Add event listener to tag filter checkboxes
                        const tagCheckboxes = document.querySelectorAll('.tag-checkbox');
                        tagCheckboxes.forEach(checkbox => {
                            checkbox.addEventListener('change', applyTagFilters);
                        });
                    }
                });
            }
            populateTags();

            // Real-time database listener for tools
            onValue(ref(db, 'tools/'), (snapshot) => {
                try {
                    const toolsList = document.getElementById('toolsList');
                    toolsList.innerHTML = '';

                    if (!snapshot.exists()) {
                        toolsList.innerHTML = '<p>No tools available yet.</p>';
                        return;
                    }

                    // Convert to array
                    tools = [];
                    snapshot.forEach((childSnapshot) => {
                        tools.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });

                    // Apply tag filters
                    applyTagFilters();

                } catch (error) {
                    console.error('Failed to load tools:', error);
                    alert('Failed to load tool rankings. Please try again later.');
                }
            });

            // Voting Function
            window.voteForTool = async function (toolId) {
                try {
                    // Check if the user has already voted for this tool using local storage
                    const votedTools = JSON.parse(localStorage.getItem('votedTools')) || [];
                    if (votedTools.includes(toolId)) {
                        alert('You have already voted for this tool.');
                        return;
                    }

                    // Proceed with voting logic
                    const toolRef = ref(db, `tools/${toolId}`);
                    const snapshot = await get(toolRef);

                    if (!snapshot.exists()) {
                        throw new Error('Tool not found');
                    }

                    const currentVotes = snapshot.val().votes;
                    await update(toolRef, {
                        votes: currentVotes + 1,
                        lastUpdated: new Date().toISOString()
                    });

                    // Store toolId in Local Storage to mark as voted
                    votedTools.push(toolId);
                    localStorage.setItem('votedTools', JSON.stringify(votedTools));

                    alert('Vote recorded!');
                } catch (error) {
                    console.error('Failed to record vote:', error);
                    alert('Failed to record vote. Please try again.');
                }
            };

            // Function to update Editor's Choice
            async function updateEditorChoice(toolId, isChecked) {
                if (!isAdmin) {
                    alert('You do not have permission to update Editor\'s Choice.');
                    return;
                }
                try {
                    const toolRef = ref(db, `tools/${toolId}`);
                    await update(toolRef, {
                        editorChoice: isChecked,
                        lastUpdated: new Date().toISOString()
                    });
                    alert('Editor\'s Choice updated!');
                } catch (error) {
                    console.error('Failed to update Editor\'s Choice:', error);
                    alert('Failed to update Editor\'s Choice. Please try again.');
                }
            }

            // Add new tool function (Admin)
            const addToolForm = document.getElementById('addToolForm');
            if (addToolForm) {
                addToolForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    if (!isAdmin) {
                        alert('You do not have permission to add tools.');
                        return;
                    }
                    try {
                        const toolName = document.getElementById('toolName').value.trim();
                        const toolLicense = document.getElementById('toolLicense').value;
                        const toolWeblink = document.getElementById('toolWeblink').value.trim();

                        // Get selected categories from checkboxes
                        const selectedCategoryCheckboxes = document.querySelectorAll('.tool-category-checkbox:checked');
                        const toolCategories = Array.from(selectedCategoryCheckboxes).map(cb => cb.value);

                        // Get selected tags from checkboxes
                        const selectedTagCheckboxes = document.querySelectorAll('.tool-tag-checkbox:checked');
                        const toolTags = Array.from(selectedTagCheckboxes).map(cb => cb.value);

                        if (!toolName || toolCategories.length === 0 || !toolLicense || !toolWeblink || toolTags.length === 0) {
                            throw new Error('Please fill in all fields');
                        }

                        const timestamp = new Date().toISOString();
                        await push(ref(db, 'tools/'), {
                            name: toolName,
                            categories: toolCategories,
                            license: toolLicense,
                            weblink: toolWeblink,
                            votes: 0,
                            editorChoice: false,
                            tags: toolTags,
                            createdAt: timestamp,
                            lastUpdated: timestamp
                        });

                        addToolForm.reset();
                        alert('Tool added successfully!');
                    } catch (error) {
                        console.error('Error adding tool:', error);
                        alert('Error: Failed to add tool. Please try again.');
                    }
                });
            }

            // Function to apply tag filters
            function applyTagFilters() {
                // Get selected tags
                const selectedTags = Array.from(document.querySelectorAll('.tag-checkbox:checked')).map(cb => cb.value);

                // Update tools display
                const toolsList = document.getElementById('toolsList');
                toolsList.innerHTML = '';

                if (tools.length === 0) {
                    toolsList.innerHTML = '<p>No tools available yet.</p>';
                    return;
                }

                // Collect all unique categories from tools
                const allCategoriesSet = new Set();
                tools.forEach(tool => {
                    if (tool.categories && Array.isArray(tool.categories)) {
                        tool.categories.forEach(cat => allCategoriesSet.add(cat));
                    }
                });
                const allCategories = Array.from(allCategoriesSet);

                // Group tools by category
                const groupedTools = {};
                allCategories.forEach(category => {
                    groupedTools[category] = tools.filter(tool => {
                        // Check if tool belongs to this category
                        const inCategory = tool.categories && tool.categories.includes(category);
                        // Filter tools based on selected tags
                        const hasSelectedTags = selectedTags.length === 0 || (tool.tags && tool.tags.some(tag => selectedTags.includes(tag)));
                        return inCategory && hasSelectedTags;
                    });
                });

                // Display tools grouped by category
                Object.keys(groupedTools).forEach(category => {
                    const categoryTools = groupedTools[category];

                    if (categoryTools.length === 0) {
                        // Skip categories with no tools after filtering
                        return;
                    }

                    // Create category section
                    const categoryElement = document.createElement('div');
                    categoryElement.className = 'category-section';
                    categoryElement.innerHTML = `<h2>${category}</h2>`;

                    // Sort and display tools
                    categoryTools.sort((a, b) => b.votes - a.votes);
                    categoryTools.forEach((tool, index) => {
                        const toolElement = document.createElement('div');
                        toolElement.className = 'tool-row';
                        toolElement.innerHTML = `
                            <div class="tool-info">
                                <span class="tool-index">${index + 1}.</span>
                                <a href="${tool.weblink}" target="_blank" class="tool-name">${tool.name}</a>
                                <span class="tool-license">${tool.license}</span>
                                <span class="tool-votes">${tool.votes} votes</span>
                                <button onclick="voteForTool('${tool.id}')" class="vote-button">Vote</button>
                                <input type="checkbox" id="editorChoice-${tool.id}" ${tool.editorChoice ? 'checked' : ''} class="editor-choice-checkbox">
                                <label for="editorChoice-${tool.id}" class="editor-choice-label">Editor's Choice</label>
                                <img src="thumbs.png" alt="Editor's Choice" class="editor-choice-icon" style="display: none;">
                            </div>
                            <span class="tool-tags">Tags: ${tool.tags && Array.isArray(tool.tags) ? tool.tags.join(', ') : 'No tags available'}</span>
                        `;
                        categoryElement.appendChild(toolElement);

                        // Add event listener for Editor's Choice checkbox
                        setTimeout(() => {
                            const editorCheckbox = document.getElementById(`editorChoice-${tool.id}`);
                            editorCheckbox.addEventListener('change', function(e) {
                                updateEditorChoice(tool.id, e.target.checked);
                            });
                        }, 0);
                    });

                    toolsList.appendChild(categoryElement);
                });

                // Update UI for role-based elements
                updateUIForRole();
            }
        });
    </script>
</body>
</html>
